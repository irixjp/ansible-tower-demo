- hosts: all
  connection: local
  tasks:
    - ec2_instance_info:
        region: ap-northeast-1
      register: ret

    - debug:
        var: ret

    - name: Collect instance info
      amazon.aws.ec2_instance_info:
        region: ap-northeast-1
        filters:
          "tag:role": ansible-demo-tag-role
      register: ec2

    - name: Retrive instance ids
      set_fact:
        delete_ids: "{{ ec2.instances | community.general.json_query(query) }}"
      vars:
        query: "[*].instance_id"

    - debug: var=delete_ids

#    - name: Delete instances
#      amazon.aws.ec2:
#        state: absent
#        instance_ids: "{{ delete_ids }}"
#        region: 
#      when: delete_ids | length > 0

